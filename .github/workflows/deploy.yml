# ===================================================================
# Deploy to Production - Branch Minimal
# ===================================================================
# Deploy automÃ¡tico para VPS quando houver push na branch
# 
# Secrets necessÃ¡rios:
#   VPS_HOST     - IP ou hostname do servidor
#   VPS_USER     - UsuÃ¡rio SSH (ex: root)
#   VPS_SSH_KEY  - Chave privada SSH (id_rsa completa)
# ===================================================================

name: Deploy to VPS

on:
  push:
    branches:
      - datageoplan-python-api-min
  workflow_dispatch:

jobs:
  deploy:
    name: ðŸš€ Deploy SICAR API
    runs-on: ubuntu-latest
    
    steps:
      - name: ðŸ“¥ Checkout
        uses: actions/checkout@v4

      - name: ðŸ” Setup SSH
        run: |
          mkdir -p ~/.ssh
          echo "${{ secrets.VPS_SSH_KEY }}" > ~/.ssh/id_rsa
          chmod 600 ~/.ssh/id_rsa
          ssh-keyscan -H ${{ secrets.VPS_HOST }} >> ~/.ssh/known_hosts

      - name: ðŸš€ Deploy to VPS
        run: |
          ssh -o StrictHostKeyChecking=no ${{ secrets.VPS_USER }}@${{ secrets.VPS_HOST }} << 'ENDSSH'
            set -e
            
            cd /opt/sicar
            
            # Verificar se Ã© um repositÃ³rio git
            if [ ! -d ".git" ]; then
              echo "âš ï¸ DiretÃ³rio nÃ£o Ã© um repositÃ³rio git. Inicializando..."
              git init
              git remote add origin https://github.com/cheri-hub/sicar-api.git
              git fetch origin datageoplan-python-api-min
              git checkout -f datageoplan-python-api-min
            else
              echo "ðŸ“¥ Pulling latest changes..."
              git fetch origin datageoplan-python-api-min
              git reset --hard origin/datageoplan-python-api-min
            fi
            
            echo "ðŸ”„ Rebuilding containers..."
            docker compose down
            docker compose up -d --build
            
            echo "â³ Waiting for containers to be healthy..."
            sleep 15
            
            echo "ðŸ” Container status:"
            docker compose ps
            
            echo "ðŸ§¹ Cleaning up old images..."
            docker image prune -f
            
            echo "âœ… Deploy completed!"
          ENDSSH

      - name: â¤ï¸ Health Check
        run: |
          echo "Waiting for API to be ready..."
          sleep 10
          response=$(curl -s -o /dev/null -w "%{http_code}" https://sicar.cherihub.cloud/api/health || echo "000")
          if [ "$response" = "200" ]; then
            echo "âœ… Health check passed! (HTTP $response)"
          else
            echo "âš ï¸ Health check returned HTTP $response"
            exit 1
          fi

      - name: ðŸ“§ Notify Success
        if: success()
        run: |
          echo "ðŸš€ Deploy successful!"
          echo "Branch: ${{ github.ref_name }}"
          echo "Commit: ${{ github.sha }}"
          echo "URL: https://sicar.cherihub.cloud"

      - name: ðŸš¨ Notify Failure
        if: failure()
        run: |
          echo "âŒ Deploy failed!"
          echo "Branch: ${{ github.ref_name }}"
          echo "Commit: ${{ github.sha }}"
          echo "Check logs for details"
